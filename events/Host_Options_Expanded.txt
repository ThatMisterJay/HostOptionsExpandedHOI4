add_namespace = Host_Options_Expanded_Setup

#Logging purposes
country_event = {
	id = Host_Options_Expanded_Setup.1
	title = Host_Options_Expanded_Setup.1.t
	desc = Host_Options_Expanded_Setup.1.d

	is_triggered_only = yes

	option = {
		name = Host_Options_Expanded_Setup.1.a
		for_each_scope_loop = {
		    array = global.playerbase

			log = "[?THIS.GetName]"
		}
	}
}

#Sorting the array through event, only a helper
country_event = {
	id = Host_Options_Expanded_Setup.2
	title = Host_Options_Expanded_Setup.2.t
	desc = Host_Options_Expanded_Setup.2.d

	is_triggered_only = yes

	option = {
		name = Host_Options_Expanded_Setup.2.a
		sort_array_by_factions = yes
	}
}

add_namespace = player_permission

#Message for host saying youre requesting permission
country_event = {
	id = player_permission.1
	title = player_permission.1.t
	desc = player_permission.1.d

	is_triggered_only = yes

	immediate = { set_global_flag = permission_being_asked }

	option = {
		name = player_permission.1.a
	}
}

#Start of game permission
country_event = {
	id = player_permission.2
	title = player_permission.2.t
	desc = player_permission.2.d

	is_triggered_only = yes

	option = {
		name = player_permission.2.a
		set_country_flag = permission_given_for_ideology_switch
	}

	option = {
		name = player_permission.2.b
		set_country_flag = permission_not_given_for_ideology_switch
	}
}

#Permission to switch faction
country_event = {
	id = player_permission.3
	title = player_permission.3.t
	desc = player_permission.3.d

	is_triggered_only = yes

	immediate = {
		event_target:selected_player = {
			set_country_flag = permission_being_asked_for_ideology_switch
			save_global_event_target_as = country_being_asked_permission
		}
	}

	option = {
		name = player_permission.3.a
		event_target:country_being_asked_permission = {
			set_country_flag = permission_given_for_ideology_switch
		}
		event_target:host_country = { country_event = { id = player_permission.7 } }
	}

	option = {
		name = player_permission.3.b
		event_target:country_being_asked_permission = {
			set_country_flag = permission_not_given_for_ideology_switch
		}
		event_target:host_country = { country_event = { id = player_permission.4 } }
	}
}

#Permission not given, start vote?
country_event = {
	id = player_permission.4
	title = player_permission.4.t
	desc = player_permission.4.d

	is_triggered_only = yes

	option = {
		name = player_permission.4.a
		event_target:country_being_asked_permission = {
			clr_country_flag = permission_being_asked_for_ideology_switch
		}
		clr_global_flag = permission_being_asked
		clear_global_event_target = country_being_asked_permission
	}

	option = {
		name = player_permission.4.b
		event_target:country_being_asked_permission = {
			set_country_flag = vote_started_for_ideology_switch
			clr_country_flag = vote_succeeded
		}
		every_country = {
			limit = { is_ai = no }
			country_event = player_permission.5
		}
		set_variable = { vote_for = 0 }
		set_variable = { vote_against = 0 }
		set_variable = { vote_total = 0 }

		#The result
		hidden_effect = { country_event = { id = player_permission.6 days = 10 } }
	}
}

#Permission not given, voting begins
country_event = {
	id = player_permission.5
	title = player_permission.5.t
	desc = player_permission.5.d

	is_triggered_only = yes

	option = {
		name = player_permission.5.a
		add_to_variable = { vote_for = 1 }
	}

	option = {
		name = player_permission.5.b
		add_to_variable = { vote_against = 1 }
	}
}

#Permission not given, voting results show variables
country_event = {
	id = player_permission.6
	title = player_permission.6.t

	is_triggered_only = yes

	immediate = {
		set_temp_variable = { vote_total = vote_for }
		add_to_temp_variable = { vote_total = vote_against }
		divide_variable = { vote_for = vote_total }
		if = {
			limit = { check_variable = { vote_for > 0.8 } }

			event_target:country_being_asked_permission = {
				set_country_flag = vote_succeeded
				set_country_flag = permission_given_for_ideology_switch
			}
		}
		else = {
			event_target:country_being_asked_permission = {
				set_country_flag = vote_failed
				set_country_flag = permission_not_given_for_ideology_switch
			}
		}
		clr_global_flag = permission_being_asked
		clear_global_event_target = country_being_asked_permission
	}

	desc = {
		text = player_permission.6.d.succeed
		trigger = { any_country = { has_country_flag = vote_succeeded } }
	}
	desc = {
		text = player_permission.6.d.fail
		trigger = { any_country = { has_country_flag = vote_failed } }
	}

	option = {
		name = player_permission.6.a
	}
}

#Permission given
country_event = {
	id = player_permission.7
	title = player_permission.7.t
	desc = player_permission.7.d

	is_triggered_only = yes

	option = {
		name = player_permission.7.a
		clr_global_flag = permission_being_asked
		clear_global_event_target = country_being_asked_permission
	}
}

#Vote already going on
country_event = {
	id = player_permission.8
	title = player_permission.8.t
	desc = player_permission.8.d

	is_triggered_only = yes

	option = {
		name = player_permission.8.a
	}
}
